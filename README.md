# iptables交互式端口访问控制系统

这是一个基于菜单的交互式脚本，用于管理iptables防火墙规则，可以方便地限制特定端口只能被指定IP访问。

## 功能特点

- 通过交互式菜单操作，无需记忆复杂命令参数
- 永久保存IP白名单，方便随时修改
- 支持对多个端口同时进行访问控制
- 支持单个添加或批量导入IP地址
- 彩色界面提示，操作直观友好
- 自动保存规则配置，系统重启后仍然有效
- 内置安全提示，防止误操作导致被锁定

## 安装与使用

### 安装

1. 下载脚本:
   ```bash
   curl -o iptables_interactive.sh https://raw.githubusercontent.com/your-username/iptables-manager/master/iptables_interactive.sh
   ```

2. 添加执行权限:
   ```bash
   chmod +x iptables_interactive.sh
   ```

3. 以root权限运行:
   ```bash
   sudo ./iptables_interactive.sh
   ```

### 使用流程

1. 首次运行时，脚本会创建配置目录和配置文件
2. 按照菜单提示进行操作：
   - 首先添加允许访问的IP地址
   - 然后配置需要限制的端口
   - 查看和管理现有规则

## 菜单选项说明

### 主菜单

- **IP地址管理** - 管理允许访问的IP白名单
  - **添加IP地址** - 逐个添加IP地址和说明
  - **批量导入IP** - 从文件批量导入IP地址列表
  - **删除IP地址** - 从白名单中删除IP
  - **查看IP列表** - 显示当前允许的所有IP

- **端口访问管理** - 配置端口访问限制
  - **配置新端口** - 为新端口设置访问限制
  - **更新端口配置** - 更新现有端口的限制规则
  - **删除端口配置** - 删除端口的访问限制
  - **更新所有端口配置** - 根据当前IP白名单更新所有端口

- **查看当前规则** - 显示当前所有iptables规则
- **备份当前规则** - 备份iptables规则到文件
- **关于和帮助** - 显示使用说明
- **退出** - 退出程序

## IP列表文件格式

如果您想使用文件批量导入IP地址，文件格式应为纯文本，每行一个IP地址。支持CIDR格式和注释，例如：

```
192.168.1.100       # 办公室电脑
10.0.0.0/24         # 公司内网
# 这是注释，会被忽略
172.16.10.5
```

## 配置文件

所有配置保存在 `/etc/iptables-manager/` 目录下:

- `allowed_ips.conf` - 允许访问的IP地址列表
- `port_config.conf` - 端口配置信息
- `iptables_backup_*.rules` - 备份的iptables规则

## 注意事项

1. **必须以root权限运行此脚本**
2. 在配置SSH端口(22)时要特别小心，确保已将自己的IP添加到白名单中
3. 系统会自动备份和保存规则，防止配置丢失
4. 配置后请验证规则是否正确生效

## 系统要求

- Linux系统（支持Debian/Ubuntu、CentOS/RHEL/Fedora等主流发行版）
- iptables防火墙
- root权限

## 问题排查

如果遇到问题：

1. 确认是否以root权限运行
2. 检查iptables是否已安装
3. 查看配置文件是否有正确的权限
4. 查看日志输出信息排查问题 
